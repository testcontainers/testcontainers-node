name: Test

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'mkdocs.yml'
      - 'docs/**'
      - 'README.md'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'mkdocs.yml'
      - 'docs/**'
      - 'README.md'

concurrency:
  group: "${{ github.workflow }}-${{ github.head_ref || github.sha }}"
  cancel-in-progress: true

jobs:
  detect-modules:
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.set-modified-modules.outputs.modules }}
      modules_count: ${{ steps.set-modified-modules-count.outputs.modules_count }}
    steps:
      - name: Check out code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - id: changed-files
        name: Get changed files
        uses: tj-actions/changed-files@4edd678ac3f81e2dc578756871e4d00c19191daf # v45.0.4

      - id: set-modified-modules
        name: Set all modified modules
        env:
          ALL_CHANGED_FILES: "${{ steps.changed-files.outputs.all_changed_files }}"
        run: echo "modules=$(./.github/scripts/changed-modules.sh)" >> $GITHUB_OUTPUT

      - id: set-modified-modules-count
        name: Set all modified modules count
        run: echo "modules_count=$(echo ${{ toJSON(steps.set-modified-modules.outputs.modules) }} | jq '. | length')" >> $GITHUB_OUTPUT

      - name: Print out the modules to be used
        run: |
          echo "${{ steps.set-modified-modules-count.outputs.modules_count }} modules in the build"
          echo "${{ steps.set-modified-modules.outputs.modules }}"

  lint:
    # only run if there are modules to lint
    if: ${{ needs.detect-modules.outputs.modules_count > 0  }}
    needs:
      - detect-modules
    strategy:
      matrix:
        module: ${{ fromJSON(needs.detect-modules.outputs.modules) }}
    runs-on: ubuntu-22.04
    steps:
    - name: Code checkout
      uses: actions/checkout@v4
    - name: Install Node and Dependencies
      uses: ./.github/actions/npm-setup
      with:
        runner: ubuntu-22.04
        node-version: 22.x
        workspace: "packages/testcontainers"
    - name: Code linting
      run: npm run lint:ci -- ${{ matrix.module }}

  smoke-test:
    # only run if there are modules to lint
    if: ${{ needs.detect-modules.outputs.modules_count > 0  }}
    name: Smoke test
    strategy:
      matrix:
        runner: [ ubuntu-22.04 ]
        node-version: [ 18.x, 20.x, 22.x ]
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Code checkout
        uses: actions/checkout@v4

      # Uses a composite action for a consistent NPM install including cache
      - name: Install Node ${{ matrix.node-version }} and Dependencies
        uses: ./.github/actions/npm-setup
        with:
          runner: ${{ matrix.runner }}
          node-version: ${{ matrix.node-version }}
          workspace: "packages/testcontainers"

      - name: Build workspaces
        run: npm run build -ws
      - name: Remove dev dependencies
        run: npm prune --omit=dev
      - name: Run CommonJS module smoke test
        run: node packages/testcontainers/smoke-test.js
      - name: Run ES module smoke test
        run: node packages/testcontainers/smoke-test.mjs

  test:
    name: Run tests
    # only run if there are modules to test
    if: ${{ needs.detect-modules.outputs.modules_count > 0  }}
    needs:
      - detect-modules
      - lint
      - smoke-test
    strategy:
      matrix:
        module: ${{ fromJSON(needs.detect-modules.outputs.modules) }}
        node-version: [ 18.x, 20.x, 22.x ]
        container-runtime: [ docker, podman ]
        include:
          - container-runtime: docker
            runner: ubuntu-22.04
          - container-runtime: podman
            runner: ubuntu-22.04
    uses: ./.github/workflows/test-template.yml
    with:
      runner: ${{ matrix.runner }}
      node-version: ${{ matrix.node-version }}
      container-runtime: ${{ matrix.container-runtime }}
      workspace: "${{ matrix.module }}"
