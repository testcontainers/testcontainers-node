on:
  workflow_call:
    inputs:
      runner:
        required: true
        type: string
      js-runtime:
        required: true
        type: string
      js-runtime-version:
        required: true
        type: string
      container-runtime:
        required: true
        type: string
      workspace:
        required: true
        type: string

jobs:
  test:
    name: "Run"
    runs-on: ${{ inputs.runner }}
    steps:
      - name: Code checkout
        uses: actions/checkout@v5

      - name: Docker rootless setup
        if: ${{ inputs.container-runtime == 'docker-rootless' }}
        uses: ./.github/actions/docker-rootless-setup

      - name: Podman setup
        if: ${{ inputs.container-runtime == 'podman' }}
        uses: ./.github/actions/podman-setup

      - name: Colima setup
        if: ${{ inputs.container-runtime == 'colima' }}
        uses: ./.github/actions/colima-setup
        with:
          runner: ${{ inputs.runner }}

      - name: Rancher Desktop setup
        if: ${{ inputs.container-runtime == 'rancher-desktop' }}
        uses: ./.github/actions/rancher-desktop-setup
        with:
          runner: ${{ inputs.runner }}

      - name: Code checkout
        uses: actions/checkout@v5

      - name: Install ${{ inputs.js-runtime }} ${{ inputs.js-runtime-version }} and Dependencies
        id: npm-install
        uses: ./.github/actions/npm-setup
        with:
          runner: ${{ inputs.runner }}
          js-runtime: ${{ inputs.js-runtime }}
          js-runtime-version: ${{ inputs.js-runtime-version }}
          workspace: "${{ inputs.workspace }}"

      - name: Run tests
        run: ${{ steps.npm-install.outputs.run_script_cmd }} test:ci -- --coverage.include=${{ steps.npm-install.outputs.workspace_path }} ${{ steps.npm-install.outputs.workspace_path }}
        env:
          CI: true
